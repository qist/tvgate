<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <link rel="stylesheet" href="{{.webPath}}static/common.css">
    <link rel="stylesheet" href="{{.webPath}}static/mobile.css">
    <style>
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--win11-bg);
            color: var(--win11-text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--win11-surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--win11-shadow);
            border: 1px solid var(--win11-border);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        h1 {
            color: var(--win11-text-primary);
            text-align: center;
            font-weight: 600;
        }

        .auth-section {
            text-align: right;
            margin-bottom: 20px;
        }

        .auth-section a {
            display: inline-block;
            padding: 8px 16px;
            background-color: var(--win11-success);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
            margin-left: 10px;
        }

        .auth-section a.logout {
            background-color: var(--win11-danger);
        }

        .auth-section a:hover {
            opacity: 0.9;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--win11-text-secondary);
        }

        .help-text {
            font-size: 13px;
            color: var(--win11-text-tertiary);
            margin-top: 5px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            background-color: var(--win11-card);
            border: 1px solid var(--win11-border);
            border-radius: 4px;
            color: var(--win11-text-primary);
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--win11-accent);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            resize: vertical;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--win11-accent);
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn:hover {
            background-color: var(--win11-accent-hover);
            transform: translateY(-1px);
        }

        .btn:active {
            background-color: var(--win11-accent-active);
            transform: translateY(0);
        }

        .btn-success {
            background-color: var(--win11-success);
        }

        .btn-success:hover {
            background-color: #57a357;
        }

        .btn-warning {
            background-color: var(--win11-warning);
            color: #000000;
        }

        .btn-warning:hover {
            background-color: #e6b800;
        }

        .btn-danger {
            background-color: var(--win11-danger);
        }

        .btn-danger:hover {
            background-color: #c40f1d;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 13px;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            transition: all 0.3s;
            animation: fadeIn 0.3s;
        }

        .alert-success {
            background-color: rgba(102, 194, 102, 0.2);
            color: var(--win11-success);
            border: 1px solid var(--win11-success);
        }

        .alert-danger {
            background-color: rgba(232, 17, 35, 0.2);
            color: var(--win11-danger);
            border: 1px solid var(--win11-danger);
        }

        .domainmap-card {
            background-color: var(--win11-card);
            border: 1px solid var(--win11-border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .domainmap-card:hover {
            background-color: var(--win11-surface);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--win11-shadow);
        }

        .domainmap-card h3 {
            margin-top: 0;
            color: var(--win11-text-primary);
            border-bottom: 1px solid var(--win11-border);
            padding-bottom: 8px;
        }

        .domainmap-card p {
            margin: 8px 0;
            color: var(--win11-text-secondary);
        }

        .domainmap-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--win11-border);
        }

        .domainmap-item-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--win11-text-primary);
        }

        .subsection {
            background-color: var(--win11-card);
            border: 1px solid var(--win11-border);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .subsection-title {
            margin-top: 0;
            color: var(--win11-text-primary);
            border-bottom: 1px solid var(--win11-border);
            padding-bottom: 8px;
            margin-bottom: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.5);
        }

        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        #list-view,
        #detail-view {
            margin-top: 20px;
        }

        #detail-view {
            display: none;
        }

        .proxy-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--win11-border);
            border-radius: 4px;
            padding: 10px;
            background-color: var(--win11-card);
        }

        .proxy-item {
            background-color: var(--win11-card);
            border: 1px solid var(--win11-border);
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .proxy-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .proxy-item-title {
            font-weight: 600;
            color: var(--win11-accent);
        }

        .btn-group-sm {
            display: flex;
            gap: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: var(--win11-surface);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--win11-border);
            border-radius: 6px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: var(--win11-text-primary);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--win11-border);
        }

        .modal-title {
            margin: 0;
            color: var(--win11-text-primary);
            font-size: 18px;
        }

        .close {
            color: var(--win11-text-tertiary);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--win11-text-primary);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .header-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .header-item input {
            flex: 1;
        }

        .header-actions button {
            background-color: var(--win11-danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 10px;
            transition: background-color 0.3s;
        }

        .header-actions button:hover {
            background-color: #c40f1d;
        }

        .domain-input-container {
            display: flex;
            margin-bottom: 5px;
        }

        .domain-input {
            flex: 1;
            margin-right: 10px;
        }

        .domain-remove-btn {
            background-color: var(--win11-danger);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 10px;
            transition: background-color 0.3s;
        }

        .domain-remove-btn:hover {
            background-color: #c40f1d;
        }

        .add-domain-btn {
            background-color: var(--win11-success);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            padding: 5px 10px;
            margin-top: 5px;
            transition: background-color 0.3s;
        }

        .add-domain-btn:hover {
            background-color: #57a357;
        }

        /* æ·»åŠ çŠ¶æ€ä¿¡æ¯è¡¨æ ¼æ ·å¼ */
        .proxy-status-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-top: 5px;
        }

        .proxy-status-table th,
        .proxy-status-table td {
            border: 1px solid #333;
            padding: 4px;
            text-align: left;
        }

        .proxy-status-table th {
            background-color: var(--win11-surface);
            font-weight: bold;
        }

        .proxy-status-table tr:nth-child(even) {
            background-color: var(--win11-bg);
        }

        .status-alive {
            color: #4CAF50;
            font-weight: bold;
        }

        .status-dead {
            color: #f44336;
            font-weight: bold;
        }

        .status-cooldown {
            color: #ff9800;
            font-weight: bold;
        }

        .status-unknown {
            color: #9E9E9E;
            font-weight: bold;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
    <script src="{{.webPath}}static/js/theme.js"></script>
</head>

<body>
    <div class="container">
        <h1>{{.title}}</h1>

        <div class="auth-section">
            <a href="{{.webPath}}" class="btn">è¿”å›é¦–é¡µ</a>
            <a href="javascript:void(0)" class="btn logout" onclick="logout()">é€€å‡ºç™»å½•</a>
        </div>

        <!-- æç¤ºä¿¡æ¯åŒºåŸŸ -->
        <div id="alert-container" class="alert hidden" role="alert"></div>

        <!-- åˆ—è¡¨è§†å›¾ -->
        <div id="list-view">
            <div class="form-buttons">
                <button type="button" class="btn btn-success" onclick="showAddProxyGroupModal()">æ·»åŠ ä»£ç†ç»„</button>
                <button type="button" class="btn" onclick="loadConfig()">é‡æ–°åŠ è½½</button>
                <button type="button" class="btn btn-primary" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
            </div>

            <div class="grid" id="proxygroups-list">
                <!-- ä»£ç†ç»„åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘ä»£ç†ç»„æ¨¡æ€æ¡† -->
        <div id="proxyGroupModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="proxyGroupModalTitle">æ·»åŠ ä»£ç†ç»„</h2>
                    <span class="close" onclick="closeProxyGroupModal()">&times;</span>
                </div>
                <input type="hidden" id="editProxyGroupName">
                <div class="form-group">
                    <label for="proxyGroupName">ç»„åç§°:</label>
                    <input type="text" id="proxyGroupName" class="form-control" placeholder="è¾“å…¥ä»£ç†ç»„åç§°">
                </div>
                <div class="form-group">
                    <label for="loadbalance">è´Ÿè½½å‡è¡¡:</label>
                    <select id="loadbalance" class="form-control">
                        <option value="round-robin">è½®è¯¢ (round-robin)</option>
                        <option value="fastest">æœ€å¿«å“åº” (fastest)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="interval">æ£€æŸ¥é—´éš”:</label>
                    <input type="text" id="interval" class="form-control" placeholder="ä¾‹å¦‚: 180s, 1m" value="180s">
                </div>
                <div class="form-group">
                    <label for="max_retries">æœ€å¤§é‡è¯•æ¬¡æ•°:</label>
                    <input type="number" id="max_retries" class="form-control" value="1" min="0">
                </div>
                <div class="form-group">
                    <label for="retry_delay">é‡è¯•å»¶è¿Ÿ:</label>
                    <input type="text" id="retry_delay" class="form-control" placeholder="ä¾‹å¦‚: 1s, 5s" value="1s">
                </div>
                <div class="form-group">
                    <label for="max_rt">æœ€å¤§å“åº”æ—¶é—´:</label>
                    <input type="text" id="max_rt" class="form-control" placeholder="ä¾‹å¦‚: 200ms, 5s" value="200ms">
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="ipv6">
                    <label for="ipv6">å¯ç”¨IPv6</label>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">ä»£ç†æœåŠ¡å™¨
                        <button type="button" class="btn btn-sm btn-success" style="float: right;"
                            onclick="showAddProxyModal()">æ·»åŠ ä»£ç†</button>
                    </h3>
                    <div id="proxy-list" class="proxy-list">
                        <div class="empty-message">æš‚æ— ä»£ç†æœåŠ¡å™¨</div>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn cancel" onclick="closeProxyGroupModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn save" id="saveProxyGroupBtn">æ·»åŠ </button>
                </div>

                <div class="subsection">
                    <h3 class="subsection-title">åŸŸåè§„åˆ™</h3>
                    <div class="help-text">è§„åˆ™é…ç½® <br>
                        åŸŸåï¼š"edgeware-live.edgeware.tvb.com" <br>
                        "*.edgeware.tvb.com" <br>
                        "hki*-edge*.edgeware.tvb.com" <br>
                        ipv4: "1.2.3.4" <br>
                        16.0.0.0/12 <br>
                        ipv6: 2001:db8::1 <br>
                        2001:db8::/32 </div>
                    <div id="domains-container">
                        <div class="empty-message">æš‚æ— åŸŸåè§„åˆ™</div>
                    </div>
                    <button type="button" class="add-domain-btn" onclick="addDomainField()">æ·»åŠ åŸŸåè§„åˆ™</button>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ /ç¼–è¾‘ä»£ç†æœåŠ¡å™¨æ¨¡æ€æ¡† -->
        <div id="proxyModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title" id="proxyModalTitle">æ·»åŠ ä»£ç†æœåŠ¡å™¨</h2>
                    <span class="close" onclick="closeProxyModal()">&times;</span>
                </div>
                <input type="hidden" id="proxyEditIndex">
                <div class="form-group">
                    <label for="proxyName">ä»£ç†åç§°:</label>
                    <input type="text" id="proxyName" class="form-control" placeholder="è¾“å…¥ä»£ç†åç§°">
                </div>
                <div class="form-group">
                    <label for="proxyType">ä»£ç†ç±»å‹:</label>
                    <select id="proxyType" class="form-control" onchange="toggleHeadersField()">
                        <option value="socks5">SOCKS5</option>
                        <option value="http">HTTP</option>
                        <option value="https">HTTPS</option>
                        <option value="socks4">SOCKS4</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="proxyServer">æœåŠ¡å™¨åœ°å€:</label>
                    <input type="text" id="proxyServer" class="form-control"
                        placeholder='ä¾‹å¦‚: 127.0.0.1 æˆ– proxy.example.com æˆ– "[::1]"'>
                </div>
                <div class="form-group">
                    <label for="proxyPort">ç«¯å£:</label>
                    <input type="number" id="proxyPort" class="form-control" placeholder="ä¾‹å¦‚: 8080" min="1" max="65535">
                </div>
                <div class="form-group checkbox-group hidden" id="proxyUDPField">
                    <input type="checkbox" id="proxyUDP">
                    <label for="proxyUDP">å¯ç”¨UDP (ä»…SOCKS5)</label>
                </div>
                <div class="form-group">
                    <label for="proxyUsername">ç”¨æˆ·å (å¯é€‰):</label>
                    <input type="text" id="proxyUsername" class="form-control">
                </div>
                <div class="form-group">
                    <label for="proxyPassword">å¯†ç  (å¯é€‰):</label>
                    <input type="password" id="proxyPassword" class="form-control">
                </div>
                <div class="form-group hidden" id="proxyHeadersField">
                    <label>Headers (å¯é€‰):</label>
                    <div id="proxyHeadersContainer"></div>
                    <button type="button" class="add-domain-btn" onclick="addHeaderField()">æ·»åŠ Header</button>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn cancel" onclick="closeProxyModal()">å–æ¶ˆ</button>
                    <button type="button" class="btn save" id="saveProxyBtn" onclick="saveProxy()">æ·»åŠ </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const webPath = "{{.webPath}}";
        window.webPath = webPath; // è®¾ä¸ºå…¨å±€å˜é‡ä¾›theme.jsä½¿ç”¨
        // console.log('webPath:', webPath);
        let proxyGroups = {};

        // é¡µé¢åŠ è½½å®Œæˆåè·å–é…ç½®
        window.addEventListener('load', function () {
            // console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åŠ è½½é…ç½®');
            loadConfig();
        });

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            alertContainer.className = `alert alert-${type}`;
            alertContainer.innerHTML = message;
            alertContainer.classList.remove('hidden');

            // 5ç§’åè‡ªåŠ¨éšè—ï¼ˆç»™ç”¨æˆ·æ›´å¤šæ—¶é—´çœ‹åˆ°æˆåŠŸæ¶ˆæ¯ï¼‰
            setTimeout(() => {
                alertContainer.classList.add('hidden');
            }, 5000);
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            // console.log('å¼€å§‹åŠ è½½é…ç½®ï¼ŒURL:', webPath + 'config/proxygroups');
            return fetch(webPath + 'config/proxygroups')
                .then(response => {
                    // console.log('æ”¶åˆ°å“åº”:', response);
                    if (!response.ok) {
                        throw new Error('åŠ è½½é…ç½®å¤±è´¥');
                    }
                    return response.json();
                })
                .then(data => {
                    // console.log('åŠ è½½åˆ°çš„é…ç½®æ•°æ®:', data);
                    proxyGroups = data || {};
                    renderProxyGroupList();
                })
                .catch(error => {
                    console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                    showAlert('åŠ è½½é…ç½®å¤±è´¥: ' + error.message, 'danger');
                });
        }

        // æ¸²æŸ“ä»£ç†ç»„åˆ—è¡¨
        function renderProxyGroupList() {
            const container = document.getElementById('proxygroups-list');
            container.innerHTML = '';

            // æ¸²æŸ“æ¯ä¸ªä»£ç†ç»„é¡¹ä¸ºå¡ç‰‡
            Object.keys(proxyGroups).forEach(name => {
                const cardElement = createProxyGroupCard(name, proxyGroups[name]);
                container.appendChild(cardElement);
            });

            // console.log('æ¸²æŸ“å®Œæˆï¼Œå½“å‰ä»£ç†ç»„:', proxyGroups);
        }

        // åˆ›å»ºä»£ç†ç»„å¡ç‰‡å…ƒç´ 
        function createProxyGroupCard(name, proxyGroup) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'domainmap-card';

            // åˆå§‹åŒ–çŠ¶æ€ä¿¡æ¯å ä½ç¬¦
            cardDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">${name || 'æœªå‘½å'}</h3>
                    <button type="button" class="btn btn-sm btn-danger" style="margin-left: auto;" onclick="deleteProxyGroup('${name}')">åˆ é™¤</button>
                </div>
                <p><strong>è´Ÿè½½å‡è¡¡:</strong> ${proxyGroup.loadbalance || 'æœªè®¾ç½®'}</p>
                <p><strong>æ£€æŸ¥é—´éš”:</strong> ${proxyGroup.interval || 'æœªè®¾ç½®'}</p>
                <p><strong>åŸŸåè§„åˆ™:</strong> ${(proxyGroup.domains && proxyGroup.domains.length) || 0} æ¡è§„åˆ™</p>
                <p><strong>ä»£ç†æœåŠ¡å™¨:</strong> ${(proxyGroup.proxies && proxyGroup.proxies.length) || 0} ä¸ª</p>
                <div class="proxy-status-container" id="status-${name}">
                    <p><strong>çŠ¶æ€ä¿¡æ¯:</strong> åŠ è½½ä¸­...</p>
                </div>
            `;
            cardDiv.onclick = function (e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è§¦å‘ç¼–è¾‘
                if (e.target.closest('.btn')) return;
                showEditProxyGroupModal(name);
            };

            // å¼‚æ­¥åŠ è½½çŠ¶æ€ä¿¡æ¯
            loadProxyGroupStatus(name, proxyGroup, cardDiv);

            return cardDiv;
        }

        // åŠ è½½ä»£ç†ç»„çŠ¶æ€ä¿¡æ¯
        function loadProxyGroupStatus(groupName, proxyGroup, cardElement) {
            const statusContainer = cardElement.querySelector('.proxy-status-container');

            // ç›´æ¥ä½¿ç”¨å½“å‰é…ç½®ä¸­çš„ç»Ÿè®¡ä¿¡æ¯
            try {
                let statusHTML = '<div class="proxy-status-details">';

                // æ˜¾ç¤ºæ¯ä¸ªä»£ç†çš„çŠ¶æ€ä¿¡æ¯
                if (proxyGroup.proxies && proxyGroup.stats && proxyGroup.stats.ProxyStats) {
                    statusHTML += '<table class="proxy-status-table">';
                    statusHTML += '<tr><th>ä»£ç†</th><th>å»¶è¿Ÿ</th><th>æœåŠ¡å™¨</th><th>HTTPçŠ¶æ€</th><th>çŠ¶æ€</th></tr>';

                    proxyGroup.proxies.forEach(proxy => {
                        const stats = proxyGroup.stats.ProxyStats[proxy.name] || {};
                        const responseTime = stats.ResponseTime > 0 ? `${(stats.ResponseTime / 1000000).toFixed(0)} ms` : '-';
                        const server = proxy.server ? `${proxy.server}:${proxy.port}` : '-';
                        const statusCode = stats.StatusCode > 0 ? stats.StatusCode : '-';

                        let statusText = 'âšª æœªæµ‹è¯•';
                        let statusClass = 'status-unknown';
                        if (stats.Alive && (stats.ResponseTime > 0 || stats.FailCount > 0)) {
                            statusText = 'âœ… æ´»è·ƒ';
                            statusClass = 'status-alive';
                        } else if (stats.CooldownUntil && new Date(stats.CooldownUntil) > new Date()) {
                            statusText = 'ğŸš« å†·å´';
                            statusClass = 'status-cooldown';
                        } else if (!stats.Alive && (stats.ResponseTime > 0 || stats.FailCount > 0)) {
                            statusText = 'âŒ å¤±è´¥';
                            statusClass = 'status-dead';
                        }

                        statusHTML += `
                            <tr>
                                <td>${proxy.name}</td>
                                <td>${responseTime}</td>
                                <td>${server}</td>
                                <td>${statusCode}</td>
                                <td class="${statusClass}">${statusText}</td>
                            </tr>
                        `;
                    });
                    statusHTML += '</table>';
                    statusHTML += '</div>';
                    statusContainer.innerHTML = `<p><strong>çŠ¶æ€ä¿¡æ¯:</strong></p>${statusHTML}`;
                } else {
                    statusContainer.innerHTML = '<p><strong>çŠ¶æ€ä¿¡æ¯:</strong> æš‚æ— æ•°æ®</p>';
                }
            } catch (error) {
                statusContainer.innerHTML = '<p><strong>çŠ¶æ€ä¿¡æ¯:</strong> åŠ è½½å¤±è´¥</p>';
                console.error('åŠ è½½ä»£ç†ç»„çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºæ·»åŠ ä»£ç†ç»„æ¨¡æ€æ¡†
        function showAddProxyGroupModal() {
            // æ¸…ç©ºè¡¨å•
            document.getElementById('editProxyGroupName').value = '';
            document.getElementById('proxyGroupName').value = '';
            document.getElementById('proxyGroupName').readOnly = false;
            document.getElementById('loadbalance').value = 'round-robin';
            document.getElementById('interval').value = '180s';
            document.getElementById('max_retries').value = '1';
            document.getElementById('retry_delay').value = '1s';
            document.getElementById('max_rt').value = '200ms';
            document.getElementById('ipv6').checked = false;

            // æ¸…ç©ºåŸŸåå’Œä»£ç†åˆ—è¡¨
            document.getElementById('domains-container').innerHTML = '<div class="empty-message">æš‚æ— åŸŸåè§„åˆ™</div>';
            document.getElementById('proxy-list').innerHTML = '<div class="empty-message">æš‚æ— ä»£ç†æœåŠ¡å™¨</div>';

            // è®¾ç½®æ ‡é¢˜å’ŒæŒ‰é’®æ–‡æœ¬
            document.getElementById('proxyGroupModalTitle').textContent = 'æ·»åŠ ä»£ç†ç»„';
            document.getElementById('saveProxyGroupBtn').textContent = 'æ·»åŠ ';
            document.getElementById('saveProxyGroupBtn').onclick = addProxyGroup;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('proxyGroupModal').style.display = 'block';
        }

        // æ˜¾ç¤ºç¼–è¾‘ä»£ç†ç»„æ¨¡æ€æ¡†
        function showEditProxyGroupModal(name) {
            const proxyGroup = proxyGroups[name];

            // å¡«å……è¡¨å•
            document.getElementById('editProxyGroupName').value = name;
            document.getElementById('proxyGroupName').value = name;
            document.getElementById('proxyGroupName').readOnly = true;
            document.getElementById('loadbalance').value = proxyGroup.loadbalance || 'round-robin';
            document.getElementById('interval').value = proxyGroup.interval || '180s';
            document.getElementById('max_retries').value = proxyGroup.max_retries || 1;
            document.getElementById('retry_delay').value = proxyGroup.retry_delay || '1s';
            document.getElementById('max_rt').value = proxyGroup.max_rt || '200ms';
            document.getElementById('ipv6').checked = proxyGroup.ipv6 || false;

            // æ¸²æŸ“åŸŸåè§„åˆ™
            renderDomainFields(proxyGroup.domains || []);

            // æ¸²æŸ“ä»£ç†æœåŠ¡å™¨åˆ—è¡¨
            renderProxyList(proxyGroup.proxies || []);

            // ç¡®ä¿ä»£ç†ç»„å¡ç‰‡æ˜¾ç¤ºæ›´æ–°
            updateProxyGroupCardProxyCount(name);

            // è®¾ç½®æ ‡é¢˜å’ŒæŒ‰é’®æ–‡æœ¬
            document.getElementById('proxyGroupModalTitle').textContent = 'ç¼–è¾‘ä»£ç†ç»„';
            document.getElementById('saveProxyGroupBtn').textContent = 'ä¿å­˜';
            document.getElementById('saveProxyGroupBtn').onclick = function () {
                updateProxyGroup(name);
            };

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('proxyGroupModal').style.display = 'block';
        }

        // å…³é—­ä»£ç†ç»„æ¨¡æ€æ¡†
        function closeProxyGroupModal() {
            document.getElementById('proxyGroupModal').style.display = 'none';
        }

        // æ¸²æŸ“åŸŸåè§„åˆ™å­—æ®µ
        function renderDomainFields(domains) {
            const container = document.getElementById('domains-container');
            container.innerHTML = '';

            if (!domains || domains.length === 0) {
                container.innerHTML = '<div class="empty-message">æš‚æ— åŸŸåè§„åˆ™</div>';
                return;
            }

            domains.forEach((domain, index) => {
                const domainDiv = document.createElement('div');
                domainDiv.className = 'domain-input-container';
                domainDiv.innerHTML = `
                    <input type="text" class="form-control domain-input" value="${domain}">
                    <button type="button" class="domain-remove-btn" onclick="removeDomainField(this)">åˆ é™¤</button>
                `;
                container.appendChild(domainDiv);
            });
        }

        // æ·»åŠ åŸŸåè§„åˆ™å­—æ®µ
        function addDomainField() {
            const container = document.getElementById('domains-container');
            // å¦‚æœæ˜¯ç©ºæ¶ˆæ¯ï¼Œå…ˆæ¸…ç©º
            if (container.querySelector('.empty-message')) {
                container.innerHTML = '';
            }

            const domainDiv = document.createElement('div');
            domainDiv.className = 'domain-input-container';
            domainDiv.innerHTML = `
                <input type="text" class="form-control domain-input" placeholder="ä¾‹å¦‚: *.example.com æˆ– 192.168.1.0/24">
                <button type="button" class="domain-remove-btn" onclick="removeDomainField(this)">åˆ é™¤</button>
            `;
            container.appendChild(domainDiv);
        }

        // åˆ é™¤åŸŸåè§„åˆ™å­—æ®µ
        function removeDomainField(button) {
            const domainItem = button.closest('.domain-input-container');
            if (domainItem) {
                domainItem.remove();

                // å¦‚æœæ²¡æœ‰åŸŸåè§„åˆ™äº†ï¼Œæ˜¾ç¤ºç©ºæ¶ˆæ¯
                const container = document.getElementById('domains-container');
                if (container.children.length === 0) {
                    container.innerHTML = '<div class="empty-message">æš‚æ— åŸŸåè§„åˆ™</div>';
                }
            }
        }

        // æ¸²æŸ“ä»£ç†æœåŠ¡å™¨åˆ—è¡¨
        function renderProxyList(proxies) {
            const container = document.getElementById('proxy-list');
            container.innerHTML = '';

            // if (!proxies || proxies.length === 0) {
            //     container.innerHTML = '<div class="empty-message">æš‚æ— ä»£ç†æœåŠ¡å™¨</div>';
            //     return;
            // }

            proxies.forEach((proxy, index) => {
                const proxyDiv = document.createElement('div');
                proxyDiv.className = 'proxy-item';
                proxyDiv.innerHTML = `
                    <div class="proxy-item-header">
                        <span class="proxy-item-title">${proxy.name || 'æœªå‘½å'}</span>
                        <div class="btn-group-sm">
                            <button type="button" class="btn btn-sm btn-warning" onclick="showEditProxyModal(${index})">ç¼–è¾‘</button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="removeProxyServer(${index})">åˆ é™¤</button>
                        </div>
                    </div>
                    <p><strong>ç±»å‹:</strong> ${proxy.type || ''}</p>
                    <p><strong>åœ°å€:</strong> ${proxy.server || ''}:${proxy.port || ''}</p>
                    ${proxy.username ? `<p><strong>ç”¨æˆ·å:</strong> ${proxy.username}</p>` : ''}
                    ${proxy.headers ? `<p><strong>Headers:</strong> ${Object.keys(proxy.headers).length} ä¸ª</p>` : ''}
                `;
                container.appendChild(proxyDiv);
            });
        }

        // æ˜¾ç¤ºæ·»åŠ ä»£ç†æ¨¡æ€æ¡†
        function showAddProxyModal() {
            // æ¸…ç©ºè¡¨å•
            document.getElementById('proxyEditIndex').value = '';
            document.getElementById('proxyName').value = '';
            document.getElementById('proxyType').value = 'socks5';
            document.getElementById('proxyServer').value = '';
            document.getElementById('proxyPort').value = '';
            document.getElementById('proxyUDP').checked = false;
            document.getElementById('proxyUsername').value = '';
            document.getElementById('proxyPassword').value = '';

            // æ¸…ç©ºå¹¶éšè—headerså®¹å™¨
            document.getElementById('proxyHeadersContainer').innerHTML = '';
            document.getElementById('proxyHeadersField').classList.add('hidden');
            document.getElementById('proxyUDPField').classList.remove('hidden');

            // è°ƒç”¨toggleHeadersFieldä»¥ç¡®ä¿UIæ­£ç¡®æ›´æ–°
            toggleHeadersField();

            // è®¾ç½®æ ‡é¢˜å’ŒæŒ‰é’®æ–‡æœ¬
            document.getElementById('proxyModalTitle').textContent = 'æ·»åŠ ä»£ç†æœåŠ¡å™¨';
            document.getElementById('saveProxyBtn').textContent = 'æ·»åŠ ';
            document.getElementById('saveProxyBtn').onclick = addProxy;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('proxyModal').style.display = 'block';
        }

        // æ˜¾ç¤ºç¼–è¾‘ä»£ç†æ¨¡æ€æ¡†
        function showEditProxyModal(index) {
            const proxy = getCurrentProxies()[index];

            // å¡«å……è¡¨å•
            document.getElementById('proxyEditIndex').value = index;
            document.getElementById('proxyName').value = proxy.name || '';
            document.getElementById('proxyType').value = proxy.type || 'socks5';
            document.getElementById('proxyServer').value = proxy.server || '';
            document.getElementById('proxyPort').value = proxy.port || '';
            document.getElementById('proxyUDP').checked = proxy.udp || false;
            document.getElementById('proxyUsername').value = proxy.username || '';
            document.getElementById('proxyPassword').value = proxy.password || '';

            // å¤„ç†headers
            const headersContainer = document.getElementById('proxyHeadersContainer');
            headersContainer.innerHTML = '';

            if (proxy.headers && Object.keys(proxy.headers).length > 0) {
                Object.keys(proxy.headers).forEach(key => {
                    const value = proxy.headers[key];
                    addHeaderField(key, value);
                });
            }

            // æ ¹æ®ä»£ç†ç±»å‹æ˜¾ç¤ºç›¸åº”çš„å­—æ®µ
            toggleHeadersField();

            // è®¾ç½®æ ‡é¢˜å’ŒæŒ‰é’®æ–‡æœ¬
            document.getElementById('proxyModalTitle').textContent = 'ç¼–è¾‘ä»£ç†æœåŠ¡å™¨';
            document.getElementById('saveProxyBtn').textContent = 'ä¿å­˜';
            document.getElementById('saveProxyBtn').onclick = updateProxy;

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            document.getElementById('proxyModal').style.display = 'block';
        }

        // å…³é—­ä»£ç†æ¨¡æ€æ¡†
        function closeProxyModal() {
            document.getElementById('proxyModal').style.display = 'none';
        }

        // æ ¹æ®ä»£ç†ç±»å‹åˆ‡æ¢æ˜¾ç¤ºå­—æ®µ
        function toggleHeadersField() {
            const proxyType = document.getElementById('proxyType').value;
            const headersField = document.getElementById('proxyHeadersField');
            const udpField = document.getElementById('proxyUDPField');

            // http/https æ˜¾ç¤ºheadersé€‰é¡¹
            if (proxyType === 'http' || proxyType === 'https') {
                headersField.classList.remove('hidden');
                udpField.classList.add('hidden');
            }
            // socks5 æ˜¾ç¤ºUDPé€‰é¡¹
            else if (proxyType === 'socks5') {
                headersField.classList.add('hidden');
                udpField.classList.remove('hidden');
            }
            // å…¶ä»–ç±»å‹éšè—ä¸¤ä¸ªé€‰é¡¹
            else {
                headersField.classList.add('hidden');
                udpField.classList.add('hidden');
            }
        }

        // æ·»åŠ Headerå­—æ®µ
        function addHeaderField(key = '', value = '') {
            const container = document.getElementById('proxyHeadersContainer');
            const headerItem = document.createElement('div');
            headerItem.className = 'header-item';
            headerItem.innerHTML = `
                <input type="text" class="form-control" placeholder="Headeråç§°" value="${key}">
                <input type="text" class="form-control" placeholder="Headerå€¼" value="${value}">
                <div class="header-actions">
                    <button type="button" onclick="removeHeaderField(this)">-</button>
                </div>
            `;
            container.appendChild(headerItem);
        }

        // åˆ é™¤Headerå­—æ®µ
        function removeHeaderField(button) {
            const headerItem = button.closest('.header-item');
            if (headerItem) {
                headerItem.remove();
            }
        }

        // è·å–å½“å‰ä»£ç†ç»„çš„ä»£ç†æœåŠ¡å™¨åˆ—è¡¨
        function getCurrentProxies() {
            const editName = document.getElementById('editProxyGroupName').value;
            if (editName && proxyGroups[editName]) {
                return proxyGroups[editName].proxies || [];
            }
            return [];
        }

        // æ·»åŠ ä»£ç†æœåŠ¡å™¨
        function addProxy() {
            const name = document.getElementById('proxyName').value.trim();
            const type = document.getElementById('proxyType').value;
            const server = document.getElementById('proxyServer').value.trim();
            const port = parseInt(document.getElementById('proxyPort').value) || 80; // é»˜è®¤ç«¯å£ 80
            const udp = document.getElementById('proxyUDP').checked;
            const username = document.getElementById('proxyUsername').value.trim();
            const password = document.getElementById('proxyPassword').value;

            if (!name || !server) {
                showAlert('è¯·å¡«å†™ä»£ç†åç§°å’ŒæœåŠ¡å™¨åœ°å€', 'danger');
                return;
            }

            const proxy = { name, type, server, port };
            if (type === 'socks5' && udp) proxy.udp = true;
            if (username) proxy.username = username;
            if (password) proxy.password = password;

            // http/https headers
            if ((type === 'http' || type === 'https') &&
                document.querySelectorAll('#proxyHeadersContainer .header-item').length > 0) {
                proxy.headers = {};
                const headerItems = document.querySelectorAll('#proxyHeadersContainer .header-item');
                headerItems.forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const key = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    if (key && value) {
                        proxy.headers[key] = value;
                    }
                });
                if (Object.keys(proxy.headers).length === 0) {
                    delete proxy.headers;
                }
            }

            const groupName = getCurrentEditGroupName();
            if (!groupName) {
                showAlert('è¯·å…ˆè¾“å…¥ä»£ç†ç»„åç§°', 'danger');
                return;
            }

            // ç¡®ä¿ä»£ç†ç»„å­˜åœ¨
            if (!proxyGroups[groupName]) {
                proxyGroups[groupName] = {
                    proxies: [],
                    domains: [],
                    loadbalance: 'round-robin',
                    interval: '180s',
                    max_retries: 1,
                    retry_delay: '1s',
                    max_rt: '200ms',
                    ipv6: false
                };
            }

            // ç¡®ä¿proxiesæ•°ç»„å­˜åœ¨
            if (!proxyGroups[groupName].proxies) {
                proxyGroups[groupName].proxies = [];
            }

            proxyGroups[groupName].proxies.push(proxy);

            renderProxyList(proxyGroups[groupName].proxies);
            updateProxyGroupCardProxyCount(groupName);

            closeProxyModal();
            showAlert('ä»£ç†æœåŠ¡å™¨æ·»åŠ æˆåŠŸï¼Œè¯·ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ä¿å­˜æ›´æ”¹', 'success');
        }

        // æ›´æ–°ä»£ç†ç»„å¡ç‰‡ä¸­çš„ä»£ç†æœåŠ¡å™¨æ•°é‡æ˜¾ç¤º
        function updateProxyGroupCardProxyCount(proxyGroupName) {
            // ä½¿ç”¨åŸç”ŸJavaScriptæ›¿ä»£:containsé€‰æ‹©å™¨
            const cards = document.querySelectorAll('.domainmap-card');
            let targetCard = null;

            // éå†æ‰€æœ‰å¡ç‰‡æ‰¾åˆ°åŒ¹é…çš„ç»„å
            for (let i = 0; i < cards.length; i++) {
                const h3 = cards[i].querySelector('h3');
                if (h3 && h3.textContent.trim() === proxyGroupName) {
                    targetCard = cards[i];
                    break;
                }
            }

            if (targetCard) {
                const proxyCountElements = targetCard.querySelectorAll('p');
                for (let i = 0; i < proxyCountElements.length; i++) {
                    if (proxyCountElements[i].textContent.includes('ä»£ç†æœåŠ¡å™¨')) {
                        // æ›´æ–°ä»£ç†æœåŠ¡å™¨æ•°é‡
                        const proxyCount = proxyGroups[proxyGroupName].proxies.length;
                        proxyCountElements[i].innerHTML = `<strong>ä»£ç†æœåŠ¡å™¨:</strong> ${proxyCount} ä¸ª`;
                        break;
                    }
                }
            }
        }

        // åˆ é™¤ä»£ç†ç»„
        function deleteProxyGroup(name) {
            if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»£ç†ç»„å—ï¼Ÿ")) {
                delete proxyGroups[name];
                renderProxyGroupList();
                showAlert('ä»£ç†ç»„å·²åˆ é™¤ï¼Œè¯·ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ä¿å­˜æ›´æ”¹', 'success');
            }
        }

        // æ›´æ–°ä»£ç†æœåŠ¡å™¨
        function updateProxy() {
            const index = parseInt(document.getElementById('proxyEditIndex').value);
            const name = document.getElementById('proxyName').value.trim();
            const type = document.getElementById('proxyType').value;
            const server = document.getElementById('proxyServer').value.trim();
            const port = parseInt(document.getElementById('proxyPort').value) || 80;
            const udp = document.getElementById('proxyUDP').checked;
            const username = document.getElementById('proxyUsername').value.trim();
            const password = document.getElementById('proxyPassword').value;

            if (!name || !server) {
                showAlert('è¯·å¡«å†™ä»£ç†åç§°å’ŒæœåŠ¡å™¨åœ°å€', 'danger');
                return;
            }

            const proxy = { name, type, server, port };
            if (type === 'socks5' && udp) proxy.udp = true;
            if (username) proxy.username = username;
            if (password) proxy.password = password;

            if ((type === 'http' || type === 'https') &&
                document.querySelectorAll('#proxyHeadersContainer .header-item').length > 0) {
                proxy.headers = {};
                const headerItems = document.querySelectorAll('#proxyHeadersContainer .header-item');
                headerItems.forEach(item => {
                    const inputs = item.querySelectorAll('input');
                    const key = inputs[0].value.trim();
                    const value = inputs[1].value.trim();
                    if (key && value) {
                        proxy.headers[key] = value;
                    }
                });
                if (Object.keys(proxy.headers).length === 0) {
                    delete proxy.headers;
                }
            }

            const groupName = getCurrentEditGroupName();
            if (groupName && proxyGroups[groupName] && proxyGroups[groupName].proxies) {
                proxyGroups[groupName].proxies[index] = proxy;
                renderProxyList(proxyGroups[groupName].proxies);
                updateProxyGroupCardProxyCount(groupName);
            }

            closeProxyModal();
            showAlert('ä»£ç†æœåŠ¡å™¨æ›´æ–°æˆåŠŸï¼Œè¯·ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ä¿å­˜æ›´æ”¹', 'success');
        }

        // è·å–å½“å‰æ­£åœ¨ç¼–è¾‘/æ–°å»ºçš„ä»£ç†ç»„å
        function getCurrentEditGroupName() {
            // é¦–å…ˆå°è¯•ä»éšè—å­—æ®µè·å–ç¼–è¾‘ä¸­çš„ä»£ç†ç»„åç§°
            let editName = document.getElementById('editProxyGroupName');
            if (editName && editName.value.trim()) {
                return editName.value.trim();
            }

            // å¦‚æœéšè—å­—æ®µä¸ºç©ºï¼Œåˆ™å°è¯•ä»ä»£ç†ç»„åç§°è¾“å…¥æ¡†è·å–
            let groupNameInput = document.getElementById('proxyGroupName');
            if (groupNameInput && groupNameInput.value.trim()) {
                return groupNameInput.value.trim();
            }

            // å¦‚æœéƒ½è·å–ä¸åˆ°ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
            return '';
        }

        // åˆ é™¤ä»£ç†æœåŠ¡å™¨
        function removeProxyServer(index) {
            const editName = getCurrentEditGroupName();

            // console.log('å½“å‰ç¼–è¾‘çš„ä»£ç†ç»„åç§°:', editName);
            // console.log('åˆ é™¤å‰çš„proxyGroups:', proxyGroups);

            if (editName && proxyGroups[editName] && proxyGroups[editName].proxies) {
                if (confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»£ç†æœåŠ¡å™¨å—ï¼Ÿ")) {
                    proxyGroups[editName].proxies.splice(index, 1);

                    // console.log('åˆ é™¤åçš„proxyGroups:', proxyGroups);

                    // æ›´æ–°å½“å‰ä»£ç†ç»„çš„ä»£ç†æœåŠ¡å™¨åˆ—è¡¨æ˜¾ç¤º
                    renderProxyList(proxyGroups[editName].proxies);

                    // æ›´æ–°ä»£ç†ç»„å¡ç‰‡æ˜¾ç¤ºçš„ä»£ç†æœåŠ¡å™¨æ•°é‡
                    updateProxyGroupCardProxyCount(editName);

                    showAlert('ä»£ç†æœåŠ¡å™¨å·²åˆ é™¤ï¼Œè¯·ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ä¿å­˜æ›´æ”¹', 'success');
                }
            } else {
                // console.log('æ— æ³•æ‰¾åˆ°å½“å‰ç¼–è¾‘çš„ä»£ç†ç»„ï¼Œä»£ç†æœåŠ¡å™¨æœªåˆ é™¤');
                showAlert('æ— æ³•æ‰¾åˆ°å½“å‰ç¼–è¾‘çš„ä»£ç†ç»„ï¼Œä»£ç†æœåŠ¡å™¨æœªåˆ é™¤', 'danger');
            }
        }

        // æ·»åŠ ä»£ç†ç»„
        function addProxyGroup() {
            const name = document.getElementById('proxyGroupName').value.trim();

            // if (proxyGroups[name]) {
            //     showAlert('ä»£ç†ç»„åç§°å·²å­˜åœ¨', 'danger');
            //     return;
            // }

            // æ”¶é›†è¡¨å•æ•°æ®ï¼Œæä¾›é»˜è®¤å€¼
            const loadbalance = document.getElementById('loadbalance').value || 'round-robin';
            const interval = document.getElementById('interval').value || '180s';
            const maxRetries = parseInt(document.getElementById('max_retries').value) || 1;
            const retryDelay = document.getElementById('retry_delay').value || '1s';
            const maxRt = document.getElementById('max_rt').value || '200ms';
            const ipv6 = document.getElementById('ipv6').checked;

            // console.log('æ”¶é›†åˆ°çš„è¡¨å•æ•°æ®:', {
            //     loadbalance,
            //     interval,
            //     maxRetries,
            //     retryDelay,
            //     maxRt,
            //     ipv6
            // });

            // æ”¶é›†åŸŸåè§„åˆ™
            const domains = [];
            const domainInputs = document.querySelectorAll('#domains-container .domain-input');
            domainInputs.forEach(input => {
                const domain = input.value.trim();
                if (domain) {
                    domains.push(domain);
                }
            });

            // console.log('æ”¶é›†åˆ°çš„åŸŸåè§„åˆ™:', domains);

            // è·å–å½“å‰ä»£ç†åˆ—è¡¨
            let currentProxies = [];
            const editName = getCurrentEditGroupName();
            if (editName && proxyGroups[editName] && proxyGroups[editName].proxies) {
                currentProxies = proxyGroups[editName].proxies;
            }

            // ç¡®ä¿åˆå§‹åŒ–proxiesæ•°ç»„
            proxyGroups[name] = {
                proxies: currentProxies,  // ä½¿ç”¨å½“å‰ä»£ç†åˆ—è¡¨è€Œä¸æ˜¯ç©ºæ•°ç»„
                domains: domains,
                ipv6: ipv6,
                interval: interval,
                loadbalance: loadbalance,
                max_retries: maxRetries,
                retry_delay: retryDelay,
                max_rt: maxRt
            };

            // console.log('æ·»åŠ çš„ä»£ç†ç»„æ•°æ®:', proxyGroups[name]);
            // console.log('å½“å‰æ‰€æœ‰ä»£ç†ç»„:', proxyGroups);

            renderProxyGroupList();
            // console.log('ä»£ç†ç»„åˆ—è¡¨å·²é‡æ–°æ¸²æŸ“');
            showAlert('ä»£ç†ç»„æ·»åŠ æˆåŠŸï¼Œè¯·ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ä¿å­˜æ›´æ”¹', 'success');
            // console.log('å³å°†å…³é—­ä»£ç†ç»„æ¨¡æ€æ¡†');
            closeProxyGroupModal();
            // console.log('ä»£ç†ç»„æ¨¡æ€æ¡†å·²å…³é—­');
            // ä¸å†ç«‹å³ä¿å­˜åˆ°åç«¯ï¼Œåªä¿å­˜åœ¨å‰ç«¯
            // ç”¨æˆ·éœ€è¦ç‚¹å‡»é¡µé¢é¡¶éƒ¨çš„ä¿å­˜æŒ‰é’®æ¥ä¿å­˜æ‰€æœ‰æ›´æ”¹
        }

        // æ›´æ–°ä»£ç†ç»„
        function updateProxyGroup(oldName) {
            const name = document.getElementById('proxyGroupName').value.trim();

            if (!name) {
                showAlert('è¯·è¾“å…¥ä»£ç†ç»„åç§°', 'danger');
                return;
            }

            const loadbalance = document.getElementById('loadbalance').value || 'round-robin';
            const interval = document.getElementById('interval').value || '180s';
            const maxRetries = parseInt(document.getElementById('max_retries').value) || 1;
            const retryDelay = document.getElementById('retry_delay').value || '1s';
            const maxRt = document.getElementById('max_rt').value || '200ms';
            const ipv6 = document.getElementById('ipv6').checked;

            const domains = [];
            const domainInputs = document.querySelectorAll('#domains-container .domain-input');
            domainInputs.forEach(input => {
                const domain = input.value.trim();
                if (domain) {
                    domains.push(domain);
                }
            });

            // å¦‚æœåç§°æ”¹å˜
            if (oldName !== name) {
                if (proxyGroups[name]) {
                    showAlert('ä»£ç†ç»„åç§°å·²å­˜åœ¨', 'danger');
                    return;
                }
                delete proxyGroups[oldName];
            }

            const existingProxies = (proxyGroups[oldName] && proxyGroups[oldName].proxies) || [];

            proxyGroups[name] = {
                proxies: existingProxies,
                domains: domains,
                ipv6: ipv6,
                interval: interval,
                loadbalance: loadbalance,
                max_retries: maxRetries,
                retry_delay: retryDelay,
                max_rt: maxRt
            };

            closeProxyGroupModal();
            renderProxyGroupList();
            showAlert('ä»£ç†ç»„æ›´æ–°æˆåŠŸï¼Œè¯·ç‚¹å‡»"ä¿å­˜é…ç½®"æŒ‰é’®ä¿å­˜æ›´æ”¹', 'success');

            // ä¸å†ç«‹å³ä¿å­˜åˆ°åç«¯ï¼Œåªä¿å­˜åœ¨å‰ç«¯
            // ç”¨æˆ·éœ€è¦ç‚¹å‡»é¡µé¢é¡¶éƒ¨çš„ä¿å­˜æŒ‰é’®æ¥ä¿å­˜æ‰€æœ‰æ›´æ”¹
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            // console.log('å¼€å§‹ä¿å­˜é…ç½®');
            // éªŒè¯å¿…å¡«å­—æ®µ
            let valid = true;
            let errorMsg = '';

            Object.keys(proxyGroups).forEach((name, index) => {
                const pg = proxyGroups[name];

                // æ£€æŸ¥ä»£ç†ç»„åç§°
                if (!name) {
                    valid = false;
                    errorMsg = `ä»£ç†ç»„ #${index + 1} çš„åç§°ä¸èƒ½ä¸ºç©º`;
                    return;
                }

                // æ£€æŸ¥ä»£ç†æœåŠ¡å™¨
                if (pg.proxies && pg.proxies.length > 0) {
                    for (let i = 0; i < pg.proxies.length; i++) {
                        const proxy = pg.proxies[i];
                        if (!proxy.name || !proxy.server || !proxy.port) {
                            valid = false;
                            errorMsg = `ä»£ç†ç»„ "${name}" ä¸­çš„ä»£ç†æœåŠ¡å™¨ #${i + 1} çš„åç§°ã€æœåŠ¡å™¨åœ°å€å’Œç«¯å£ä¸èƒ½ä¸ºç©º`;
                            return;
                        }
                    }
                }
            });

            if (!valid) {
                showAlert(errorMsg, 'danger');
                return;
            }

            // å‡†å¤‡è¦å‘é€çš„æ•°æ®
            const cleanProxyGroups = {};
            Object.keys(proxyGroups).forEach(name => {
                const pg = proxyGroups[name];
                // åˆ›å»ºä¸€ä¸ªæ·±æ‹·è´ä»¥é¿å…ä¿®æ”¹åŸå§‹æ•°æ®
                const cleaned = JSON.parse(JSON.stringify(pg));
                cleanProxyGroups[name] = cleaned;
            });

            // console.log('å‡†å¤‡å‘é€çš„æ•°æ®:', cleanProxyGroups);

            // æ£€æŸ¥æ˜¯å¦æœ‰æ•°æ®
            if (Object.keys(cleanProxyGroups).length === 0) {
                showAlert('æ²¡æœ‰æ•°æ®éœ€è¦ä¿å­˜', 'warning');
                return;
            }

            fetch(webPath + 'config/save-proxygroups', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cleanProxyGroups)
            })
                .then(response => {
                    // console.log('æ”¶åˆ°å“åº”:', response);
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || 'ä¿å­˜å¤±è´¥');
                        });
                    }
                    return response.text();
                })
                .then(data => {
                    // console.log('ä¿å­˜æˆåŠŸ:', data);
                    showAlert('é…ç½®ä¿å­˜æˆåŠŸ,ç‚¹å‡»é‡æ–°åŠ è½½', 'success');
                    // ä¿å­˜æˆåŠŸååˆ·æ–°åˆ—è¡¨
                    return loadConfig();
                })
                .then(() => {
                    // console.log('é…ç½®é‡æ–°åŠ è½½å®Œæˆ');
                })
                .catch(error => {
                    console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                    showAlert('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message, 'danger');
                });
        }

        // åˆ é™¤ä»£ç†ç»„
        function removeProxyGroup(name) {
            deleteProxyGroup(name);
        }


        // é€€å‡ºç™»å½•
        function logout() {
            if (hasUnsavedChanges()) {
                if (!confirm('æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                    return;
                }
            }

            fetch(webPath + 'logout', {
                method: 'POST'
            })
                .then(() => {
                    window.location.href = webPath + 'login';
                })
                .catch(error => {
                    console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                    window.location.href = webPath + 'login';
                });
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰æœªä¿å­˜çš„æ›´æ”¹
        function hasUnsavedChanges() {
            // è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œå®é™…åº”è¯¥æ¯”è¾ƒåŸå§‹æ•°æ®å’Œå½“å‰æ•°æ®
            return true;
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function (event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        function saveProxyGroup() {
            // console.log('saveProxyGroup function called');
            // è·å–è¡¨å•æ•°æ®
            const groupName = document.getElementById('proxyGroupName').value;
            const loadbalance = document.getElementById('loadbalance').value;
            const interval = document.getElementById('interval').value;
            const maxRetries = document.getElementById('max_retries').value;
            const retryDelay = document.getElementById('retry_delay').value;
            const maxRT = document.getElementById('max_rt').value;
            const ipv6 = document.getElementById('ipv6').checked;

            // æ‰“å°è·å–çš„æ•°æ®
            // console.log('Group Name:', groupName);
            // console.log('Load Balance:', loadbalance);
            // console.log('Interval:', interval);
            // console.log('Max Retries:', maxRetries);
            // console.log('Retry Delay:', retryDelay);
            // console.log('Max RT:', maxRT);
            // console.log('IPv6 Enabled:', ipv6);

            // è¿™é‡Œå¯ä»¥æ·»åŠ ä¿å­˜æ•°æ®çš„é€»è¾‘ï¼Œä¾‹å¦‚å‘é€ AJAX è¯·æ±‚ç­‰
            // ç¤ºä¾‹ï¼š
            // sendDataToServer({ groupName, loadbalance, interval, maxRetries, retryDelay, maxRT, ipv6 });
        }
    </script>
</body>

</html>