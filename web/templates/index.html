<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.title}}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .auth-section {
            text-align: right;
            margin-bottom: 20px;
        }
        .auth-section a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
            margin-left: 10px;
        }
        .auth-section a.logout {
            background-color: #dc3545;
        }
        .auth-section a:hover {
            opacity: 0.8;
        }
        .menu {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        .menu a {
            display: inline-block;
            padding: 12px 24px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .menu a:hover {
            background-color: #0056b3;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        .section h2 {
            margin-top: 0;
        }
        .info ul {
            padding-left: 20px;
        }
        .info li {
            margin-bottom: 10px;
        }
        .monitor-section {
            margin: 30px 0;
        }
        .monitor-section h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .proxy-group {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
        }
        .proxy-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .proxy-group-title {
            font-weight: bold;
            font-size: 18px;
        }
        .edit-btn {
            display: inline-block;
            padding: 6px 12px;
            background-color: #ffc107;
            color: #212529;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .edit-btn:hover {
            background-color: #e0a800;
        }
        .proxy-table {
            width: 100%;
            border-collapse: collapse;
        }
        .proxy-table th,
        .proxy-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .proxy-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .status-alive {
            color: green;
            font-weight: bold;
        }
        .status-dead {
            color: red;
            font-weight: bold;
        }
        .status-cooldown {
            color: orange;
            font-weight: bold;
        }
        .status-unknown {
            color: gray;
            font-weight: bold;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="auth-section">
            <a href="{{.webPath}}login" id="login-link" style="display:none;">ç™»å½•</a>
            <a href="{{.webPath}}logout" id="logout-link" class="logout" style="display:none;">é€€å‡º</a>
        </div>
        
        <h1>{{.title}}</h1>
        
        <div class="menu">
            <a href="{{.webPath}}editor">æ€»ä½“é…ç½®ç¼–è¾‘å™¨</a>
            <a href="{{.webPath}}node-editor">èŠ‚ç‚¹é…ç½®ç¼–è¾‘å™¨</a>
            <a href="{{.monitorPath}}" target="_blank">ç³»ç»Ÿç›‘æ§é¡µé¢</a>
        </div>

        <div class="monitor-section">
            <h2>ä»£ç†ç»„ç›‘æ§</h2>
            <div class="monitor-content" id="monitor-content">
                <p>æ­£åœ¨åŠ è½½ç›‘æ§æ•°æ®...</p>
            </div>
        </div>
        
        <div class="info">
            <h2>ä½¿ç”¨è¯´æ˜</h2>
            <ul>
                <li>ç‚¹å‡»"æ€»ä½“é…ç½®ç¼–è¾‘å™¨"å¯ä»¥åœ¨çº¿ç¼–è¾‘å®Œæ•´ TVGate é…ç½®æ–‡ä»¶</li>
                <li>ç‚¹å‡»"èŠ‚ç‚¹é…ç½®ç¼–è¾‘å™¨"å¯ä»¥æŒ‰èŠ‚ç‚¹ç¼–è¾‘ TVGate é…ç½®æ–‡ä»¶</li>
                <li>ç‚¹å‡»"ç³»ç»Ÿç›‘æ§é¡µé¢"å¯ä»¥åœ¨æ–°çª—å£ä¸­æŸ¥çœ‹è¯¦ç»†ç³»ç»Ÿç›‘æ§ä¿¡æ¯</li>
                <li>ç¼–è¾‘å®Œæˆåç‚¹å‡»ä¿å­˜æŒ‰é’®å°†ä¿å­˜é…ç½®åˆ°æœåŠ¡å™¨</li>
                <li>ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»ºé…ç½®æ–‡ä»¶å¤‡ä»½ï¼Œæ–‡ä»¶åä¸ºåŸé…ç½®æ–‡ä»¶ååŠ ä¸Š .backup åç¼€</li>
                <li>å¦‚æœä¿å­˜å¤±è´¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ¢å¤å¤‡ä»½æ–‡ä»¶</li>
                <li>è¯·ç¡®ä¿é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼Œå¦åˆ™æ— æ³•ä¿å­˜</li>
            </ul>
        </div>
        
        <div class="info">
            <h2>å®‰å…¨æé†’</h2>
            <ul>
                <li>è¯·å‹¿åœ¨å…¬å…±ç½‘ç»œç¯å¢ƒä¸‹ä½¿ç”¨æ­¤åŠŸèƒ½</li>
                <li>è¯·å®šæœŸæ›´æ”¹ç®¡ç†è´¦å·å¯†ç </li>
                <li>é…ç½®æ–‡ä»¶åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼Œè¯·å¦¥å–„ä¿ç®¡è®¿é—®æƒé™</li>
            </ul>
        </div>
    </div>
    
    <script>
        // è·å–Webè·¯å¾„å‰ç¼€
        const webPath = "{{.webPath}}";
        
        // æ£€æŸ¥ç”¨æˆ·è®¤è¯çŠ¶æ€
        function checkAuthStatus() {
            fetch(webPath + 'auth-status')
                .then(response => response.json())
                .then(data => {
                    const loginLink = document.getElementById('login-link');
                    const logoutLink = document.getElementById('logout-link');
                    
                    if (data.authenticated) {
                        loginLink.style.display = 'none';
                        logoutLink.style.display = 'inline-block';
                        logoutLink.textContent = `é€€å‡º (${data.username})`;
                    } else {
                        loginLink.style.display = 'inline-block';
                        logoutLink.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('æ£€æŸ¥è®¤è¯çŠ¶æ€å¤±è´¥:', error);
                });
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåæ£€æŸ¥è®¤è¯çŠ¶æ€
        window.addEventListener('load', function() {
            checkAuthStatus();
            
            // è·å–é…ç½®å¹¶åŠ¨æ€ç”Ÿæˆç»„é“¾æ¥
            Promise.all([
                fetch(webPath + 'config'),
                fetch('{{.monitorPath}}?format=json')
            ])
            .then(responses => Promise.all(responses.map(r => r.text())))
            .then(([configData, monitorData]) => {
                const config = jsyaml.load(configData);
                const monitor = JSON.parse(monitorData);
                
                // æ˜¾ç¤ºç›‘æ§ä¿¡æ¯
                displayMonitorInfo(monitor);
            })
            .catch(error => {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                document.getElementById('monitor-content').innerHTML = '<p style="color: red;">åŠ è½½ç›‘æ§æ•°æ®å¤±è´¥: ' + error.message + '</p>';
            });
        });
        
        // æ˜¾ç¤ºç›‘æ§ä¿¡æ¯
        function displayMonitorInfo(monitor) {
            const monitorContent = document.getElementById('monitor-content');
            
            if (!monitor.ProxyGroups) {
                monitorContent.innerHTML = '<p>æš‚æ— ä»£ç†ç»„ç›‘æ§æ•°æ®</p>';
                return;
            }
            
            let html = '';
            for (const [groupName, group] of Object.entries(monitor.ProxyGroups)) {
                html += `
                <div class="proxy-group">
                    <div class="proxy-group-header">
                        <span class="proxy-group-title">${groupName} (è´Ÿè½½å‡è¡¡: ${group.LoadBalance})</span>
                        <a href="${webPath}node-editor?node=proxygroups&group=${encodeURIComponent(groupName)}" class="edit-btn">ç¼–è¾‘ç»„</a>
                    </div>
                    <table class="proxy-table">
                        <thead>
                            <tr>
                                <th>ä»£ç†</th>
                                <th>ç±»å‹</th>
                                <th>æœåŠ¡å™¨</th>
                                <th>çŠ¶æ€</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                for (const proxy of group.Proxies) {
                    const stats = group.Stats && group.Stats.ProxyStats ? group.Stats.ProxyStats[proxy.Name] : null;
                    let statusText = '<span class="status-unknown">âšª æœªåˆå§‹åŒ–</span>';
                    let statusClass = 'status-unknown';
                    
                    if (stats) {
                        if (stats.Alive && (stats.ResponseTime > 0 || stats.FailCount > 0)) {
                            statusText = '<span class="status-alive">âœ… æ´»è·ƒ</span>';
                            statusClass = 'status-alive';
                        } else if (stats.CooldownUntil && new Date(stats.CooldownUntil) > new Date()) {
                            statusText = '<span class="status-cooldown">ğŸš« å†·å´</span>';
                            statusClass = 'status-cooldown';
                        } else if (!stats.Alive && (stats.ResponseTime > 0 || stats.FailCount > 0)) {
                            statusText = '<span class="status-dead">âŒ æ­»äº¡</span>';
                            statusClass = 'status-dead';
                        } else {
                            statusText = '<span class="status-unknown">âšª æœªæµ‹è¯•</span>';
                            statusClass = 'status-unknown';
                        }
                    }
                    
                    html += `
                        <tr>
                            <td>${proxy.Name}</td>
                            <td>${proxy.Type || ''}</td>
                            <td>${proxy.Server || ''}</td>
                            <td>${statusText}</td>
                        </tr>
                    `;
                }
                
                html += `
                        </tbody>
                    </table>
                    <div style="margin-top: 10px;">
                        <a href="${webPath}node-editor?node=proxygroups" class="edit-btn">ç¼–è¾‘æ‰€æœ‰ä»£ç†ç»„</a>
                    </div>
                </div>
                `;
            }
            
            monitorContent.innerHTML = html;
        }
    </script>
</body>
</html>